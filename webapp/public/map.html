<html>
<head>
    <title>Car Communication App</title>

    <!-- bring in the OpenLayers javascript library
         (here we bring it from the remote site, but you could
         easily serve up this javascript yourself) -->
    <script src="OpenLayers.js"></script>
    <!--script src="http://www.openlayers.org/api/OpenLayers.js"></script-->
 
    <!-- bring in the OpenStreetMap OpenLayers layers.
         Using this hosted file will make sure we are kept up
         to date with any necessary changes -->
    <script src="OpenStreetMap.js"></script>
    <!--script src="http://www.openstreetmap.org/openlayers/OpenStreetMap.js"></script-->

    <!-- The geo-location-javascript code -->
    <script src="http://code.google.com/apis/gears/gears_init.js"></script>
    <script src="geo.js"></script>

    <!-- The personal functions from CS -->
    <script src="csfuncs.js"></script>

    <script type="text/javascript">

function csErrorHandler (msg, file, line) {
	var fullMsg = "General Error: " + msg + " in file: " + file + ":" + line;
	setStatus("GeneralStatus", "General: " + fullMsg, "red");
	return true;
};

OpenLayers.Util.onImageLoadError = function() {
	setStatus("MapStatus", "Map: Cannot load images", "red");
};
 
// Complex object of type OpenLayers.Map
var map;
var layerGpx1;
var layerGpx2;
var useLayerGpx1;
var gpxStyleMap;
var serverUrl;
var initialized;
var lastPos;
var currentPos;
var sendInterval;

// Global error handler
window.onerror = csErrorHandler;


function setLatLon(lat, lon) {
	var lonLat = new OpenLayers.LonLat(lon, lat).transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject());
	var currentZoom = map.getZoom();
	map.setCenter (lonLat, currentZoom);
}

function zoomTo(lat, lon, zoom) {
	var lonLat = new OpenLayers.LonLat(lon, lat).transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject());
	map.setCenter (lonLat, zoom);
}

function zoomToHamburg() {
	// Start position for the map (hardcoded here for simplicity)
	zoomTo(53.5514, 9.99, 12);
}

function zoomToMuenchen() {
	zoomTo(48.1361, 11.5376, 12);
}

function on_geo_error(p) {
    setStatus("GPSStatus", "GPS Error: " + p.message, "red");
}

function on_geo_success(p) {
    setStatus("GPSStatus", "GPS received", "lightgreen");
    setLatLon(p.coords.latitude, p.coords.longitude);
    currentPos = p;
    sendDataMaybe();
    loadWays(1, dateToString(new Date()));
}

function on_interval() {
    if (currentPos) {
        var now = new Date();
        var diffmsec = now.getTime() - currentPos.timestamp;
        var diffsec = diffmsec / 1000;
        var diffstr = diffsec.toFixed(1);
        setStatus("GPSStatus",
                  "GPS received: " + diffstr + "s old",
                  "lightgreen");
        if (diffsec >= sendInterval) {
            // Uh, we need to create a new object here
            currentPos = { timestamp: now.getTime(),
                           coords : {
                    latitude : currentPos.coords.latitude,
                    longitude : currentPos.coords.longitude
                }};
            sendDataMaybe();
        }
    }
}

function sendDataMaybe() {
    if (currentPos) {
        if (!lastPos)
            lastPos = currentPos;
        var diffmsec = currentPos.timestamp - lastPos.timestamp;
        var diffsec = diffmsec / 1000;
        if (diffsec >= sendInterval) {
            sendDataNow();
        }
    }
}

function sendDataNow() {
    if (!currentPos) {
        setStatus("SendStatus", "No Valid Positions to send", "red");
        return;
    }
    if (!lastPos) {
        lastPos = currentPos;
    }
    var endTimestamp = currentPos.timestamp;
    var diffsec = (endTimestamp - lastPos.timestamp) / 1000;
    if (diffsec == 0) {
        endTimestamp = (new Date()).getTime();
        diffsec = (endTimestamp - lastPos.timestamp) / 1000;
    }
    var endLat = currentPos.coords.latitude.toFixed(6);
    var endLon = currentPos.coords.longitude.toFixed(6);
    var startLat = lastPos.coords.latitude.toFixed(6);
    var startLon = lastPos.coords.longitude.toFixed(6);
    var time = dateToString(new Date(endTimestamp));
    if (diffsec == 0) {
        setStatus("SendStatus", "Oops, diffsec = 0", "red");
        alert("currentPos.timestamp=" + currentPos.timestamp + " lastPos.timestamp=" + lastPos.timestamp + " date=" + (new Date()).getTime());
        return;
    }
    var dur = diffsec.toFixed(2);

    var url = serverUrl + "slices";
    var params = "slice[lat]=" + endLat
        + "&slice[lon]=" + endLon
        + "&slice[time]=" + time
        + "&slice[duration]=" + dur
        + "&slice[startlat]=" + startLat
        + "&slice[startlon]=" + startLon;

    var http = new XMLHttpRequest();
    http.open("POST", url, true);
    //Send the proper header information along with the request
    http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    http.setRequestHeader("Content-length", params.length);
    http.setRequestHeader("Connection", "close");

    http.onreadystatechange = function() { //Call a function when the state changes.
	if (http.readyState) {
            if (http.status == 200) {
                setStatus("SendStatus", "Position sent (200)", "lightgreen");
                //alert(http.responseText);
            } else {
                setStatus("SendStatus", "Position not sent (" + http.status + ")", "yellow");
                //alert(http.responseText);
            }
	}
    }
    http.send(params);

    //alert("Will send: " + url + "?" + params);
}

//Initialise the 'map' object
function init() {
 
        sendInterval = 60;
	serverUrl = "";
	useLayerGpx1 = true;

	// Did we get our auxiliary files? Then switch General to green
	if (OpenLayers && csCreateMap) {
		setStatus("GeneralStatus", null, "lightgreen");
	}

        if (typeof(window.google) != "undefined" && typeof(window.google.gears) != "undefined"){
            setStatus("GPSStatus", "GPS: Google Gears available", "lightyellow");
        } else if (typeof(navigator.geolocation) != "undefined") {
            setStatus("GPSStatus", "GPS: Mozilla Navigator available", "lightyellow");
        } else {
            setStatus("GPSStatus", "GPS: Please install Google Gears, http://gears.google.com", "yellow");
        }

	// Define the map layer
	map = csCreateMap();

	// Define the styles for the way slices
	gpxStyleMap = csCreateGpxStyleMap();


        //determine if the handset has client side geo location capabilities
        if (geo_position_js.init()) {
            geo_position_js.watchPosition(on_geo_success, on_geo_error);
//                                           {enableHighAccuracy : true,
//                                                   timeout : 1000, // milliseconds
//                                                   maximumAge : 10000 // milliseconds
//                                                   });
        }
        else{
            on_geo_error({message: "No GPS available"});
        }

	// Choose Hamburg as center
	zoomToHamburg();

	initialized = 1;

	loadWays(1, dateToString(new Date()));

        setInterval(on_interval, 1000);
}

function setServerUrl(value) {
	serverUrl = value;
}

function loadWays(min_time, max_time) {
	if (useLayerGpx1) {
		if (layerGpx2) {
			layerGpx2.visibility = true;
		}
		if (layerGpx1) {
			map.removeLayer(layerGpx1);
			layerGpx1.destroy();
		}
		layerGpx1 = loadWaysLayer(min_time, max_time);
		map.addLayer(layerGpx1);
		layerGpx1.visibility = false;

		useLayerGpx1 = false;
	} else {
		if (layerGpx1) {
			layerGpx1.visibility = true;
		}
		if (layerGpx2) {
			map.removeLayer(layerGpx2);
			layerGpx2.destroy();
		}
		layerGpx2 = loadWaysLayer(min_time, max_time);
		map.addLayer(layerGpx2);
		layerGpx2.visibility = false;

		useLayerGpx1 = true;
	}
}

function on_gpx_loadstart() {
    setStatus("SliceStatus", "Loading ways... " + this.features.length, "lightyellow");
}

function on_gpx_loadend() {
    var numWays = this.features.length;
    if (numWays > 0)
        setStatus("SliceStatus", "Way Lines: Received " + numWays + " lines", "lightgreen");
    else
        setStatus("SliceStatus", "Way Lines: No lines received", "yellow");
}

function on_osm_loadstart() {
    setStatus("MapStatus", "Loading Map...", "yellow");
}

function on_osm_tileloaded() {
    var numRemainingTiles = this.numLoadingTiles;
    if (numRemainingTiles > 0)
        setStatus("MapStatus", "Loading map; " + this.numLoadingTiles + " images remaining", "lightgreen");
    else
        setStatus("MapStatus", "Map Loaded", "lightgreen");
}

function loadWaysLayer(min_time, max_time) {
	var lonLatUR = map.getLonLatFromPixel(new OpenLayers.Pixel(0,0))
		.transform(map.getProjectionObject(),
				   new OpenLayers.Projection("EPSG:4326"));

	var mapSize = map.getSize();
	var lonLatLL = map.getLonLatFromPixel(new OpenLayers.Pixel(mapSize.w, mapSize.h))
		.transform(map.getProjectionObject(),
				   new OpenLayers.Projection("EPSG:4326"));

	var min_lat = lonLatLL.lat;
	var max_lon = lonLatLL.lon;
	var max_lat = lonLatUR.lat;
	var min_lon = lonLatUR.lon;

	// Add the Layer with GPX Track
	var layerGpx = csCreateLayerGpx(serverUrl,
                                        min_lat, max_lat,
                                        min_lon, max_lon,
                                        min_time, max_time);

        layerGpx.events.register("loadend", layerGpx, on_gpx_loadend);
        layerGpx.events.register("loadstart", layerGpx, on_gpx_loadstart);

	return layerGpx;
}

function setStatus(id, text, bgcolor) {
	var td = document.getElementById(id);
	if (td) {
		if (text)
			td.firstChild.nodeValue = text;
		if (bgcolor)
			td.setAttribute("bgcolor", bgcolor);
	} else {
		window.onerror ("Function setStatus() was called with non-existing ID of html element, \"" + id + "\"");
	}
}

    </script>

</head>

<!-- body.onload is called once the page is loaded (call the 'init' function) -->
<body onload="init();">

<table border="1" width="100%"><tr>
	<td align="center" id="GeneralStatus" bgcolor="yellow">General</td>
	<td align="center" id="GPSStatus" bgcolor="lightyellow">GPS Receiver</td>
	<td align="center" id="MapStatus" bgcolor="yellow">Map Status</td>
	<td align="center" id="SliceStatus" bgcolor="lightyellow">Way Lines</td>
	<td align="center" id="SendStatus" onclick="sendDataNow();">Sending to Server</td>
</tr></table>

<!-- define a DIV into which the map will appear. Make it take up 400 pixels -->
<div id="map"></div>

</body>
</html>

<!-- Local Variables: -->
<!-- mode: javascript -->
<!-- indent-tabs-mode:nil -->
<!-- c-basic-offset:4 -->
<!-- tab-width:8 -->
<!-- End: -->
